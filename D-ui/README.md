# D-ui 图形化界面

IoT项目的图形化界面模块，用于控制发布端脚本并展示采集端数据。

## 📋 功能特性

- **发布端控制**：通过QProcess控制B-publisher脚本，支持开始/停止发布数据
- **MQTT订阅**：实时订阅MQTT消息，接收温度、湿度、气压数据
- **数据可视化**：实时显示数据趋势图，使用Matplotlib绘制折线图
- **数据表格**：以表格形式显示接收到的数据，包含日期、时间点和数值
- **每日统计**：自动计算并显示每日的最高值、最低值和平均值
- **多指标支持**：温度、湿度、气压三个指标独立控制和显示

## 🚀 快速开始

### 1. 安装依赖

```bash
cd loT/D-ui
pip install -r requirements.txt
```

### 2. 运行程序

```bash
python main.py
```

## 📁 项目结构

```
D-ui/
├── main.py              # 主程序入口
├── config.py            # 配置管理
├── requirements.txt     # 依赖包
├── pages/
│   ├── home.py         # 首页
│   ├── publisher.py    # 发布端控制页面
│   └── viewer.py       # 订阅端数据查看页面
├── workers/
│   ├── http_worker.py  # HTTP请求工作线程
│   └── mqtt_worker.py  # MQTT订阅工作线程
└── resources/
    └── *.png           # 背景图片资源
```

## 🔧 配置说明

### MQTT配置

- MQTT Broker地址：`139.224.237.20:1883`
- 用户名：`collector`
- 密码：`col123`
- 连接方式：TCP（非WebSocket）
- 可在 `config.py` 中修改MQTT配置

### B-publisher脚本路径

- 默认路径：`B-publisher/publish.py`（相对于项目根目录）
- 如需修改，编辑 `config.py` 中的 `PUBLISHER_SCRIPT`

## 📖 使用说明

### 发布端控制

1. 点击首页的"发布端"按钮进入发布端控制页面
2. 选择要发布的指标（温度/湿度/气压）
3. 点击"开始发布[指标]数据"按钮启动发布
4. 发布过程中，按钮会变为禁用状态，"停止发布"按钮会启用
5. 点击"停止发布[指标]数据"按钮停止发布
6. 每个指标都有独立的开始/停止按钮，可以同时控制多个指标

### 订阅端数据查看

1. 点击首页的"订阅端"按钮进入订阅端页面
2. 选择要订阅的指标标签页（温度/湿度/气压）
3. 点击"订阅[指标]数据"按钮开始订阅MQTT消息
4. 订阅成功后，会实时接收并显示数据：
   - **数据表格**：显示日期、时间点和数值
   - **趋势图表**：实时绘制数据趋势折线图
5. 当一天的数据接收完成后，会自动在表格中显示该日的统计信息（最高/最低/平均）
6. 再次点击订阅按钮可以取消订阅

## ⚠️ 注意事项

1. **运行前确保**：
   - MQTT Broker已启动并可访问（`139.224.237.20:1883`）
   - B-publisher脚本路径正确
   - Python环境已安装所需依赖（见requirements.txt）

2. **MQTT连接**：
   - MQTT订阅在后台线程执行，不会阻塞UI
   - 连接失败会显示错误提示对话框
   - 订阅成功后，数据会实时显示在表格和图表中

3. **进程控制**：
   - 使用QProcess管理B-publisher脚本
   - 停止时会优雅退出（stop -> terminate -> kill）

4. **数据格式**：
   - MQTT消息格式：`{"ts": "2014-02-13T00:00:00", "value": 4.0}`
   - 主题格式：`env/temperature`、`env/humidity`、`env/pressure`

## 🐛 故障排查

### 问题1：无法启动发布脚本
- 检查脚本路径是否正确（默认：`B-publisher/publish.py`）
- 确认Python环境已安装paho-mqtt
- 查看响应标签的错误信息

### 问题2：无法连接MQTT Broker
- 确认MQTT Broker地址正确（`139.224.237.20:1883`）
- 检查网络连接是否正常
- 确认MQTT用户名和密码正确（`collector/col123`）
- 查看错误提示对话框的详细信息

### 问题3：订阅后没有收到数据
- 确认发布端正在发布数据
- 检查MQTT主题是否正确（`env/temperature`、`env/humidity`、`env/pressure`）
- 确认MQTT消息格式正确（包含`ts`和`value`字段）
- 查看订阅按钮状态是否显示"取消订阅"

### 问题4：图表不显示数据
- 确认已成功订阅MQTT主题
- 检查是否收到MQTT消息（查看数据表格）
- 确认数据格式正确（时间戳和数值都是有效的）

