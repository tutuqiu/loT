# 系统运行说明

## ⚠️ 重要：为什么数据库数据少？

### 问题原因

1. **主题不匹配**（已修复）：
   - B-publisher 发布到 `ingest/env/{metric}`
   - C-collector 订阅 `env/#`
   - 需要 Gateway Proxy 转发，或者使用 admin 用户

2. **C-collector 没有运行**：
   - 必须运行 C-collector 才能接收数据
   - 数据不会自动进入数据库

3. **数据被覆盖**：
   - 数据库使用 `UNIQUE(metric, ts)` 约束
   - 相同时间戳的数据会被替换，而不是新增

## ✅ 正确的运行步骤

### 1. 启动 C-collector（必须先启动）

```bash
cd E:\IOT_Final_Project\loT\C-collector
python collector.py
```

**必须看到：**
```
✓ 已连接到 Broker: 139.224.237.20:1883
✓ 正在订阅主题: env/#
✓ 订阅成功! 等待消息...
```

### 2. 启动 B-publisher（在GUI中）

1. 运行 GUI：
   ```bash
   cd E:\IOT_Final_Project\loT\D-ui
   python main.py
   ```

2. 进入"发布端控制"页面

3. 选择指标（温度/湿度/气压）

4. 点击"Start"按钮开始发布

5. **等待发布完成**（查看日志中的进度信息）

### 3. 检查数据

```bash
cd E:\IOT_Final_Project\loT\C-collector
python check_database.py
```

## 🔍 诊断步骤

### 检查1：C-collector是否在运行？

查看 C-collector 的控制台输出，应该看到：
```
[DEBUG] 收到消息: topic=env/temperature
📊 [temperature] ts=2014-02-13T00:00:00, value=4.0
```

如果没有看到这些信息，说明：
- C-collector 没有运行
- 或者 MQTT 连接失败

### 检查2：数据是否被接收？

运行检查脚本：
```bash
cd E:\IOT_Final_Project\loT\C-collector
python check_database.py
```

如果数据没有增加，可能原因：
1. C-collector 没有运行
2. 主题不匹配（已修复）
3. MQTT 连接问题

### 检查3：是否有重复时间戳？

运行检查脚本：
```bash
cd E:\IOT_Final_Project\loT\C-collector
python check_duplicates.py
```

如果有很多重复时间戳，说明数据文件中有重复数据。

## 📝 已修复的问题

1. ✅ **主题匹配**：B-publisher 现在直接发布到 `env/{metric}`
2. ✅ **用户权限**：使用 admin 用户，有全部权限
3. ✅ **默认速率**：改为 10Hz，发布更快

## 🚀 现在请重新测试

1. **确保 C-collector 正在运行**
2. **在 GUI 中重新发布数据**
3. **等待发布完成**（查看日志进度）
4. **检查数据库**（运行 check_database.py）

如果数据仍然很少，请告诉我：
- C-collector 的控制台输出
- B-publisher 的日志输出
- 数据库检查结果

